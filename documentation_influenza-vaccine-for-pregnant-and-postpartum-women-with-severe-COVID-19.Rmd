---
title: "Documentation of the article 'Influenza vaccine confers protection against severe COVID-19 perinatally'"
author: 'Codes and outputs'
date: "December 02, 2021"
header-includes:
  - \usepackage{float}
  - \renewcommand{\contentsname}{Sumário}
output:   
  pdf_document:
    toc: yes
    toc_depth: '1'
    keep_tex: yes
  word_document: default
  html_document:
    self_contained: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
\newpage
# Description
 
This file presents the documentation of the analysis of article "Influenza vaccine confers protection against severe COVID-19 perinatally".


# About the database and R packages used

The data are analyzed using the free-software R (https://www.R-project.org) in version 4.0.3. Next, we present and load the libraries used in the data analysis process.

```{r pacotes, echo=TRUE, message=FALSE, warning =FALSE,error=FALSE, results='hide'}
#load packages
loadlibrary <- function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = T)
    if (!require(x, character.only = TRUE))
      stop("Package not found")
  }
}

packages <-
  c(
    "readr",
    "readxl",
    "janitor",
    "dplyr",
    "forcats",
    "stringr",
    "lubridate",
    "summarytools",
    "magrittr",
    "questionr", 
    "knitr",
    "data.table",
    "modelsummary", 
    "kableExtra", 
    "DescTools", 
    "ggplot2",
    "effectsize",
    "WeightIt",
    "MatchIt",
    "ggplot2",
    "ggpubr"
  )

lapply(packages, loadlibrary)
```

One can see below the functions that will be used in the data analysis.
```{r,echo=TRUE, eval=TRUE, message=FALSE,warning =FALSE,error=FALSE,results='hide'}
#functions for summary measures
media <- function(x)
  mean(x, na.rm = TRUE)
mediana <- function(x)
  median(x, na.rm = TRUE)
DP <- function(x)
  sd(x, na.rm = TRUE)
minimo <- function(x)
  base::min(x, na.rm = TRUE)
maximo <- function(x)
  base::max(x, na.rm = TRUE)
q25 <- function(x)
  stats::quantile(x, p = 0.25, na.rm = TRUE)
q75 <- function(x)
  stats::quantile(x, p = 0.75, na.rm = TRUE)
IQR <- function(x)
  round(q75(x) - q25(x), 2)
n <- function(x)
  sum(!is.na(x))
```

This is a retrospective cohort study using the data from the Influenza Epidemiological Surveillance Information System, SIVEP-Gripe (Sistema de Informação de Vigilância Epidemiológica da Gripe) database. 

The SIVEP-Gripe is a nationwide surveillance database created to monitor severe acute respiratory infections and data on virus circulation and respiratory infections in Brazil. Flu cases should be notified for individuals presenting fever and cough and/or sore throat in sentinel monitoring units.  In 2009, with the burden of the H1N1 pandemic, a rigorous surveillance of the cases of severe acute respiratory syndrome (SARS) was adopted, with compulsory notification of all SARS cases.  The definition of SARS included the presence of fever, cough and dyspnea.  Since 2010, only hospitalized cases of SARS must be notified, both in public and in private hospitals, as well as cases of deaths caused by SARS, irrespective of hospitalization. Once virus surveillance for public health purposes has dynamic characteristics, frequent updates are made in notification guidelines.  At the time of COVID-19 pandemic, cases of SARS must be notified in the presence of at least two of the following symptoms: fever, chills, sore throat, headache, cough, runny nose, olfactory or taste disorders PLUS dyspnea or chest pressure or saturation less than 95% or blue coloration of lips or face. Only cases of hospitalized SARS or SARS-related death must be notified.
The SIVEP-Gripe records contain demographic, clinical and epidemiological data, as well as laboratory/etiological results.  There is also information about hospital admission and disease progression (recovery or death). 

The period analyzed comprises epidemiological data from 2020, with a database obtained on August 10, 2021 on the website https://opendatasus.saude.gov.br/dataset/bd-srag-2020, and from 2021, with a database obtained on August 10, 2021 on the website https://opendatasus.saude.gov.br/dataset/bd-srag-2021. These datasets can be obtained at https://drive.google.com/drive/folders/1s3SwBWlCRS9pkEsv2sWftA-qGqJ_jTA1?usp=sharing. They are loaded and combined below:

```{r,echo=FALSE, eval=TRUE, message=FALSE,warning =FALSE,error=FALSE,results='hide'}
 memory.limit(999999)
```

```{r,echo=TRUE,message=FALSE,warning =FALSE,error=FALSE,results='hide'}
#loading the datasets
#2021
dados_a <- read_delim(
  "INFLUD21-02-08-2021.csv",
  ";",
  escape_double = FALSE,
  locale = locale(encoding = "ISO-8859-2"),
  trim_ws = TRUE
)

#2020
dados_b <- read_delim(
  "INFLUD-02-08-2021.csv",
  ";",
  escape_double = FALSE,
  locale = locale(encoding = "ISO-8859-2"),
  trim_ws = TRUE
)


#### Concatenating 2020 and 2021 datasets ##############
dados_a <- dados_a %>% 
  mutate(FATOR_RISC = case_when(FATOR_RISC == 1 ~ "S", 
                                FATOR_RISC == 2 ~ "N"))
dados_b <- dados_b %>% 
  mutate(FATOR_RISC = case_when(FATOR_RISC == 1 ~ "S", 
                                FATOR_RISC == 2 ~ "N"))

# dados_b$OBES_IMC <- as.numeric(dados_b$OBES_IMC)

dados <- full_join(dados_a, dados_b)

#Create case year variable
dados <-  dados %>%
  dplyr::mutate(
    dt_sint = as.Date(DT_SIN_PRI, format = "%d/%m/%Y"), #date of first symptoms
    dt_nasc = as.Date(DT_NASC, format = "%d/%m/%Y"), #date of birth
    dt_vac_gripe = as.Date(DT_UT_DOSE, format = "%d/%m/%Y"), #date of Influenza vaccine
    ano = lubridate::year(dt_sint), #year of the case
  )
```

There are `r dim(dados)[1]` observations in the database. To see the dictionary of variables, access (in Portuguese):
https://opendatasus.saude.gov.br/dataset/ae90fa8f-3e94-467e-a33f-94adbb66edf8/resource/8f571374-c555-4ec0-8e44-00b1e8b11c25/download/dicionario-de-dados-srag-hospitalizado-27.07.2020-final.pdf
 
 
# Case selection and data treatment

The first filter is to select cases from February 16, 2020 (8th epidemiological week of symptoms of 2020) to May 1, 2021 (epidemiological week 17 of 2021).

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#selection of cases from February 16, 2020 (8th epidemiological week of symptoms of 2020) 
#to May 1, 2021 (week 17 of 2021).
sem <- 17

dados1 <- dados %>% 
  filter((ano == 2020 & SEM_PRI >=8) | ano == 2021)

#week 53 has the first two days of 2021 and the year is 2021, but it's actually 2020.
dados1 <- dados1 %>% 
  mutate(ano = ifelse(ano == 2021 & SEM_PRI ==53, 2020, ano)) %>%  
  filter(ano == 2020 | (ano == 2021 & SEM_PRI <= sem))
```

There are `r dim(dados1)[1]` observations in the database after selection of valid years.

The next selection is female:
```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#filtering F
dados2 <- filter(dados1, CS_SEXO == "F")
```

There are `r dim(dados2)[1]` observations in the database.

Selection of women of childbearing age (10 to 55 years): 

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#creating the age variable as the difference between dt_sint and dt_nasc.
#In cases without dt_nasc, we consider
#the NU_AGE_N field
dados2 <- dados2 %>% 
  mutate(
         idade = as.period(interval(start = dt_nasc, end = dt_sint))$year, 
         age = ifelse(is.na(idade), NU_IDADE_N, idade)
  )

#Filtering of cases aged 55 and under
dados3 <- dados2 %>% 
  filter(age > 9 & age <= 55)
```

There are `r dim(dados3)[1]` observations in the database.


The next step is to identify pregnant and postpartum people (variable `classi_gesta_puerp`) and then select only those cases.

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#Creating the classification variable if pregnant, postpartum and 
##neither pregnant nor postpartum
dados3 <- dados3 %>%
  mutate(
    classi_gesta_puerp = case_when(
      CS_GESTANT == 1  ~ "1tri",
      CS_GESTANT == 2  ~ "2tri",
      CS_GESTANT == 3  ~ "3tri",
      CS_GESTANT == 4  ~ "IG_ig",
      CS_GESTANT == 5 &
        PUERPERA == 1 ~ "puerp",
      CS_GESTANT == 9 & PUERPERA == 1 ~ "puerp",
      TRUE ~ "não" #no
    )
  )

freq(dados3$classi_gesta_puerp)

#filtering only pregnant and postpartum women
dados4 <- dados3 %>%
  filter(classi_gesta_puerp != "não")
```

There are `r dim(dados4)[1]` observations in the database.

We selected only confirmed cases of COVID-19.

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
dados4 <- dados4 %>% 
  mutate(
    classi_fin = case_when(
      CLASSI_FIN == 5 ~ "covid",
      TRUE ~ "não" #no
    )
  )


#filtering only covid cases 
dados5 <- dados4 %>% 
    filter(CLASSI_FIN == 5)
```

There are `r dim(dados5)[1]` observations in the database.

Now let's select the cases of COVID by PCR or antigen, but which are also not positive for Influenza.

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#COVID case diagnosed by PCR
dados5 <- dados5 %>%
  mutate(pcr_covid_SN = case_when(
    (PCR_SARS2 == 1) |
      (
        str_detect(DS_PCR_OUT, "SARS|COVID|COV|CORONA|CIVID") 
      ) ~ "sim", #yes
    TRUE ~ "não" #no
  ))

#Influenza case diagnosed by PCR 
dados5 <- dados5 %>%
  mutate(pcr_influenza_SN = case_when(
    (POS_PCRFLU == 1) |
      (
        str_detect(DS_PCR_OUT, "INFLU|INFLUENZA") 
      ) ~ "sim", #yes
    TRUE ~ "não" #no
  ))

with(dados5, table(pcr_influenza_SN,pcr_covid_SN))
```

There are 10 cases that are positive for COVID and for Influenza by PCR.

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#Case of COVID diagnosed by antigen
dados5 <- dados5 %>%
  mutate(antigenio_covid_SN = case_when(
    (AN_SARS2 == 1) |
      (
        str_detect(DS_AN_OUT, "SARS|COVID|COV|CORONA|CIVID") 
      ) ~ "sim", #yes
    TRUE ~ "não" #no
  ))


#Influenza case diagnosed by antigen
dados5 <- dados5 %>%
  mutate(antigenio_influenza_SN = case_when(
    (POS_AN_FLU == 1) |
      (
        str_detect(DS_AN_OUT, "INFLU|INFLUENZA") 
      ) ~ "sim", #yes
    TRUE ~ "não" #no
  ))

with(dados5, table(antigenio_influenza_SN, antigenio_covid_SN))
```

There are no positive cases for COVID and for Influenza by antigen.

We will now select the cases of COVID confirmed by PCR or antigen.

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
with(dados5, table(pcr_covid_SN, antigenio_covid_SN))

#filtering only covid cases by PCR or antigen
dados6 <- dados5 %>% 
    filter(pcr_covid_SN == "sim" | antigenio_covid_SN == "sim")
```

There are `r dim(dados6)[1]` observations in the database.

Now it's time to remove cases that are also positive for Influenza.

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
with(dados6, table(pcr_influenza_SN, antigenio_influenza_SN))

#filtering only negative cases of Influenza by PCR or antigen
dados7 <- dados6 %>% 
    filter(pcr_influenza_SN != "sim" & antigenio_influenza_SN != "sim") #'sim' means 'yes'
```

There are `r dim(dados7)[1]` observations in the database.

Finally, we will only select the finalized cases (death or cure). The variable that indicates the outcome is `EVOLUCAO`, with the categories: 1-Cure; 2-Death; 3- Death from other causes; 9-Ignored.

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
with(dados7, freq(EVOLUCAO))
```

Let's select only the finalized cases:

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#filtering only completed cases
dados8 <- dados7 %>% 
  filter((EVOLUCAO == 1 | EVOLUCAO == 2 | EVOLUCAO == 3) & !is.na(EVOLUCAO))


#creating the evolution variable
dados8 <- dados8 %>% 
  mutate(death = case_when(
    EVOLUCAO == 1 ~ "cure", 
    EVOLUCAO == 2 ~ "death",
    EVOLUCAO == 3 ~ "death"
  ))

with(dados8, freq(death))
```

There are `r dim(dados8)[1]` observations in the database.

## Vaccination variable analysis

Let's look at the variable that indicates whether the person was vaccinated for H1n1 (variable `vaccine`). 

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#recoding the influenza vaccine variable
dados8 <- dados8 %>% 
  mutate(vaccine = case_when(
    VACINA == 1 ~ "yes", 
    VACINA == 2 ~ "no",
    TRUE ~ NA_character_
  ))
#Influenza vaccine indicator frequency table
with(dados8, freq(vaccine))
```

Let's now create the time variable between the Influenza vaccine (for those who took it) and the first symptoms of COVID-19.

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
dados8 <- dados8 %>% 
  mutate(
    time_vaccine_symptoms = as.numeric(dt_sint - dt_vac_gripe)
  ) 

dados8_aux <- dados8 %>% 
  filter(vaccine == "no")
sum(is.na(dados8_aux$time_vaccine_symptoms))

dados8_aux <- dados8 %>% 
  filter(is.na(vaccine))
sum(is.na(dados8_aux$time_vaccine_symptoms))

dados8_aux <- dados8 %>% 
  filter(vaccine == "yes")
summary(dados8_aux$time_vaccine_symptoms)
```

Note that when `vaccine = no` there is no information about time between vaccine and symptoms, as expected.

Among those vaccinated, there are 403 pregnant and postpartum women without information on the date of vaccination. Note that there is still negative data (date of first symptom was less than date of Influenza vaccination). 

The next step is filtering cases that the vaccine was applied before the first symptoms of COVID-19 for those who have been vaccinated.

```{r,echo=TRUE, eval=TRUE, message=FALSE,warning =FALSE,error=FALSE,results='hide'}
#Filtering positive time_vaccine_symptoms (vaccine before sympthoms)
data_final <- dados8 %>% 
  filter(vaccine == "no" | (vaccine == "yes" & time_vaccine_symptoms > 0))
```

```{r,echo=TRUE, eval=TRUE, message=FALSE,warning =FALSE,error=FALSE}
with(data_final, freq(vaccine))
```

# Epidemiologic characteristics 


```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
# Ethnicity
data_final <-  data_final %>%
  mutate(
    ethnicity = case_when(
      CS_RACA == 1 ~ "white",
      CS_RACA == 2 ~ "black",
      CS_RACA == 3 ~ "yellow",
      CS_RACA == 4 ~ "brown",
      CS_RACA == 5 ~ "indigenous",
      TRUE ~ NA_character_
    ), 
    white_color = case_when(
      ethnicity == "white" ~ "yes", 
      is.na(ethnicity) ~ NA_character_, 
      TRUE ~ "no"
    )
  )

# Education
data_final <-  data_final %>%
  mutate(
    education = case_when(
      CS_ESCOL_N == 0 ~ "no school",
      CS_ESCOL_N == 1 ~ "fund1",
      CS_ESCOL_N == 2 ~ "fund2",
      CS_ESCOL_N == 3 ~ "high school",
      CS_ESCOL_N == 4 ~ "college",
      TRUE ~ NA_character_
    ), 
    education2 = case_when(
      CS_ESCOL_N <= 2 ~ "up to 9 years", 
      CS_ESCOL_N == 3 ~ "from 9 to 12 years", 
      CS_ESCOL_N == 4 ~ "over 12 years",
      TRUE ~ NA_character_
    )
  )
data_final$education2 <-
  factor(data_final$education2, levels = c("up to 9 years", "from 9 to 12 years", "over 12 years"))

# Age group
data_final <-  data_final %>%
  mutate(
    age_group = case_when(
      age <= 19 ~ "<20",
      age >= 20
      & age <= 34 ~ "20-34",
      age >= 35 ~ ">=35",
      TRUE ~ NA_character_
    )
  )
data_final$age_group <-
  factor(data_final$age_group, levels = c("<20", "20-34", ">=35"))


# residence area
data_final <-  data_final %>%
  mutate(
    residence = case_when(
      CS_ZONA == 1 ~ "urban",
      CS_ZONA == 2 ~ "rural",
      CS_ZONA == 3 ~ "periurban",
      TRUE ~ NA_character_
    )
  )

```

## Ethnicity

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
with(data_final, ctable(ethnicity, vaccine,  prop = "c", useNA = "no", chisq = FALSE, OR = TRUE))
```

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
fisher.test(data_final$ethnicity, data_final$vaccine)
```

## White color

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
with(data_final, ctable(white_color, vaccine,  prop = "c", useNA = "no", chisq = TRUE, OR = TRUE))
```


## Education

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
with(data_final, ctable(education, vaccine, prop = "c", useNA = "no", chisq = FALSE, OR = TRUE))
```

## Education (years)

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
with(data_final, ctable(education2, vaccine, prop = "c", useNA = "no", chisq = TRUE, OR = TRUE))
```


## Gestational moment 

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
with(data_final, ctable(classi_gesta_puerp, vaccine, prop = "c", useNA = "no", chisq = TRUE, OR = TRUE))
```

## Age 

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
datasummary((vaccine) ~ age*(n+media+DP+mediana+q25+q75+IQR),
            data = data_final, output = 'markdown')
```

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#t-test
t.test(age ~ vaccine, data = data_final)
```

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#effect size
c_cohen <- cohens_d(age ~ as.factor(vaccine), data=data_final)
c_cohen
interpret_d(c_cohen$Cohens_d,rules="cohen1988")
```

## Age group

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
with(data_final, ctable(age_group, vaccine, prop = "c", useNA = "no", chisq = TRUE, OR = TRUE))
```

## Residence area
```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
with(data_final, ctable(residence, vaccine, prop = "c", useNA = "no", chisq = FALSE, OR = TRUE))
```

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
fisher.test(data_final$residence, data_final$vaccine)
```

# Comorbities

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#Cardiac
data_final <-  data_final %>%
  mutate(cardiac = case_when(CARDIOPATI == 1 ~ "yes",
                             CARDIOPATI == 2 ~ "no",
                             TRUE ~ NA_character_))

#Hematologic
data_final <-  data_final %>%
  mutate(hematologic = case_when(HEMATOLOGI == 1 ~ "yes",
                                 HEMATOLOGI == 2 ~ "no",
                                 TRUE ~ NA_character_))

#Hepatic
data_final <-  data_final %>%
  mutate(hepatic = case_when(HEPATICA == 1 ~ "yes",
                             HEPATICA == 2 ~ "no",
                             TRUE ~ NA_character_))

#Asthma
data_final <-  data_final %>%
  mutate(asthma = case_when(ASMA == 1 ~ "yes",
                            ASMA == 2 ~ "no",
                            TRUE ~ NA_character_))

#Diabetes
data_final <-  data_final %>%
  mutate(diabetes = case_when(DIABETES == 1 ~ "yes",
                              DIABETES == 2 ~ "no",
                              TRUE ~ NA_character_))

#Neurologic
data_final <-  data_final %>%
  mutate(neurologic = case_when(NEUROLOGIC == 1 ~ "yes",
                                NEUROLOGIC == 2 ~ "no",
                                TRUE ~ NA_character_))

#Pneumologic
data_final <-  data_final %>%
  mutate(pneumologic = case_when(PNEUMOPATI == 1 ~ "yes",
                                 PNEUMOPATI == 2 ~ "no",
                                 TRUE ~ NA_character_))

#Imunossupression
data_final <-  data_final %>%
  mutate(imuno = case_when(IMUNODEPRE == 1 ~ "yes",
                           IMUNODEPRE == 2 ~ "no",
                           TRUE ~ NA_character_))

#Renal
data_final <-  data_final %>%
  mutate(renal = case_when(RENAL == 1 ~ "yes",
                           RENAL == 2 ~ "no",
                           TRUE ~ NA_character_))

#Obesity
data_final <-  data_final %>%
  mutate(obesity = case_when(OBESIDADE == 1 ~ "yes",
                             OBESIDADE == 2 ~ "no",
                             TRUE ~ NA_character_))

#Any comorbidity

df <- data_final %>% 
  select(cardiac,obesity,hematologic,hepatic,asthma,diabetes,neurologic,pneumologic,imuno,renal)

#if all comorbities in df are NA (not available), return NA.
soma <- function(x){
  if (sum(is.na(x))==10)
    return(NA_character_)
  else
    return(sum(!is.na(x) & x=="yes")) 
}
data_final$qt_comorb_aux <- apply(df,1,soma)

data_final <- data_final %>%
  mutate(comorbidity = case_when(qt_comorb_aux >=1 ~ "yes",
                                 qt_comorb_aux ==0 ~ "no",
                                 TRUE ~ NA_character_))

```


### Cardiac

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, cardiac, prop = "r", useNA = "no", chisq = TRUE, OR = TRUE))
```

###  Hematologic

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, hematologic, prop = "r", useNA = "no", chisq = FALSE, OR = TRUE))
```

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
fisher.test(data_final$hematologic, data_final$vaccine)
```

###  Diabetes

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
ctable(data_final$vaccine, data_final$diabetes, chisq=TRUE, prop="r",  useNA = "no", OR = TRUE)
```

###  Obesity

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
ctable(data_final$vaccine, data_final$obesity, chisq=TRUE, prop="r",  useNA = "no", OR = TRUE)
```

###  Asthma

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
ctable(data_final$vaccine, data_final$asthma, chisq=TRUE, prop="r",  useNA = "no", OR = TRUE)
```

###  Hepatic

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
ctable(data_final$vaccine, data_final$hepatic, chisq=FALSE, prop="r",  useNA = "no", OR = TRUE)
```

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
fisher.test(data_final$vaccine, data_final$hepatic)
```


###  Neurologic

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
ctable(data_final$vaccine, data_final$neurologic, chisq=TRUE, prop="r",  useNA = "no", OR = TRUE)
```

###  Pneumologic

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
ctable(data_final$vaccine, data_final$pneumologic, chisq=TRUE, prop="r",  useNA = "no", OR = TRUE)
```

###  Imunossupression

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
ctable(data_final$vaccine, data_final$imuno, chisq=TRUE, prop="r", useNA = "no", OR = TRUE)
```

###  Renal

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
ctable(data_final$vaccine, data_final$renal, chisq=FALSE, prop="r",  useNA = "no", OR = TRUE)
```

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
fisher.test(data_final$renal, data_final$vaccine)
```

### Any comorbidity

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, comorbidity, prop = "r", useNA = "no", chisq = TRUE, OR = TRUE))
```


# Symptoms

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
# Fever
data_final <-  data_final %>%
  mutate(fever = case_when(FEBRE == 1 ~ "yes",
                           FEBRE == 2 ~ "no",
                           TRUE ~ NA_character_))

# Cough
data_final <-  data_final %>%
  mutate(cough = case_when(TOSSE == 1 ~ "yes",
                           TOSSE == 2 ~ "no",
                           TRUE ~ NA_character_))

# Sore throat
data_final <-  data_final %>%
  mutate(sore_throat = case_when(GARGANTA == 1 ~ "yes",
                                 GARGANTA == 2 ~ "no",
                                 TRUE ~ NA_character_))

# Dyspnea
data_final <-  data_final %>%
  mutate(dyspnea = case_when(DISPNEIA == 1 ~ "yes",
                             DISPNEIA == 2 ~ "no",
                             TRUE ~ NA_character_))

# Respiratory discomfort
data_final <-  data_final %>%
  mutate(resp_disc = case_when(DESC_RESP == 1 ~ "yes",
                               DESC_RESP == 2 ~ "no",
                               TRUE ~ NA_character_))

# Desaturation
data_final <-  data_final %>%
  mutate(desaturation = case_when(SATURACAO == 1 ~ "yes",
                                  SATURACAO == 2 ~ "no",
                                  TRUE ~ NA_character_))

# Diarrhea
data_final <-  data_final %>%
  mutate(diarrhea = case_when(DIARREIA == 1 ~ "yes",
                              DIARREIA == 2 ~ "no",
                              TRUE ~ NA_character_))

# Vomit
data_final <-  data_final %>%
  mutate(vomit = case_when(VOMITO == 1 ~ "yes",
                           VOMITO == 2 ~ "no",
                           TRUE ~ NA_character_))

# Abdominal pain
data_final <-  data_final %>%
  mutate(abd_pain = case_when(DOR_ABD == 1 ~ "yes",
                              DOR_ABD == 2 ~ "no",
                              TRUE ~ NA_character_))

# Fatigue
data_final <-  data_final %>%
  mutate(fatigue = case_when(FADIGA == 1 ~ "yes",
                             FADIGA == 2 ~ "no",
                             TRUE ~ NA_character_))

# Olfactory loss
data_final <-  data_final %>%
  mutate(olfac_loss = case_when(PERD_OLFT == 1 ~ "yes",
                                PERD_OLFT == 2 ~ "no",
                                TRUE ~ NA_character_))

# Loss of taste
data_final <-  data_final %>%
  mutate(loss_taste = case_when(PERD_PALA == 1 ~ "yes",
                                PERD_PALA == 2 ~ "no",
                                TRUE ~ NA_character_))

# Any respiratory symptom
df <- data_final %>% 
  select(dyspnea,fatigue,desaturation,resp_disc)

soma <- function(x){
  if (sum(is.na(x))==4)
    return(NA_character_)
  else
    return(sum(!is.na(x) & x=="yes")) 
}
data_final$qt_sintomas_resp_aux <- apply(df,1,soma)

data_final <-  data_final %>%
  mutate(resp_symp = case_when(qt_sintomas_resp_aux >=1 ~ "yes",
                               qt_sintomas_resp_aux ==0 ~ "no",
                               TRUE ~ NA_character_))
# Any symptom
df <- data_final %>% 
  select(dyspnea,fatigue,desaturation,resp_disc,
         fever,cough,sore_throat,diarrhea,vomit,abd_pain,olfac_loss,loss_taste)
soma <- function(x){
  if (sum(is.na(x))==12)
    return(NA_character_)
  else
    return(sum(!is.na(x) & x=="yes")) 
}
data_final$qt_sintomas_aux <- apply(df,1,soma)

data_final <-  data_final %>%
  mutate(symptom = case_when(qt_sintomas_aux >= 1 ~ "yes",
                             qt_sintomas_aux == 0 ~ "no",
                             TRUE ~ NA_character_))
```

## Fever

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, fever, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

## Cough

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, cough, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```


## Sore throat

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, sore_throat, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

##  Dyspnea

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, dyspnea, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

##  Respiratory discomfort

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, resp_disc, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

## Desaturation

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, desaturation, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

## Diarrhea

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, diarrhea, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

##  Vomit

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, vomit, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

## Abdominal pain

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, abd_pain, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

## Fatigue

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, fatigue, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

## Olfactory loss

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, olfac_loss, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

## Loss of taste

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, loss_taste, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

## Any respiratory symptom

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, resp_symp, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

## Any symptom

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, symptom, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```


# Outcome

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
# Hospitalization
data_final <- data_final %>%
  mutate(hospitalization = case_when(HOSPITAL == 1 ~ "yes",
                         HOSPITAL == 2 ~ "no",
                         TRUE ~ NA_character_))

# ICU
data_final <- data_final %>%
  mutate(icu = case_when(UTI == 1 ~ "yes",
                         UTI == 2 ~ "no",
                         TRUE ~ NA_character_))


# Length time in ICU
data_final<-  data_final%>% 
  mutate(dt_enticu  = as.Date(DT_ENTUTI,  format = "%d/%m/%Y"),
         dt_exicu = as.Date(DT_SAIDUTI, format = "%d/%m/%Y"), 
         time_icu = as.numeric(dt_exicu - dt_enticu)
  )

# ventilatory support
data_final <- data_final %>% 
  mutate(ventilatory_support = case_when(SUPORT_VEN == 1 ~ "invasive",
                                SUPORT_VEN == 2 ~ "non-invasive",
                                  SUPORT_VEN == 3 ~ "no",
                                TRUE ~ NA_character_))

# Intubation
data_final <- data_final %>% 
  mutate(intubation = case_when(SUPORT_VEN == 1 ~ "yes",
                                SUPORT_VEN == 2 | SUPORT_VEN == 3 ~ "no",
                                TRUE ~ NA_character_))


```

## Hospitalization

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, hospitalization, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```


## ICU

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, icu, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

## Length time in ICU
```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
data_final_aux <- data_final %>% 
  filter (icu == "yes")
```

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
datasummary((vaccine) ~ time_icu*(n+media+DP+mediana+q25+q75+IQR),
            data = data_final_aux, output = 'markdown')
```

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#t-test
t.test(time_icu ~ vaccine, data = data_final_aux)
```

## Ventilatory support

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, ventilatory_support, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

## Intubation

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, intubation, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

## Death

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_final, ctable(vaccine, death, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```


# Time between covid vaccine and first symptoms of covid-19

Selecting only the vaccinated cases
```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
data_final_aux <- data_final %>% 
  filter (vaccine == "yes") 

data_final_aux$death <-
  factor(data_final_aux$death, levels = c("cure", "death"), label =  c("cure", "death"))
```

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
datasummary((death) ~ time_vaccine_symptoms*(n+media+DP+mediana+q25+q75+IQR),
            data = data_final_aux, output = 'markdown')
```

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#t-test
t.test(time_vaccine_symptoms ~ death, data = data_final_aux)
```


# Propensity Scoring Matching (PSM) 

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
data_final <- data_final %>% 
  mutate(vaccine1 = ifelse(vaccine == "yes",1,0),
         id = 1:dim(data_final)[1]) 

data_final1 <- data_final %>% 
  select(id, vaccine1, white_color, age, education2, asthma)

data_final1 <- data_final1 %>% 
  mutate(
    white_color1 = ifelse(is.na(white_color) == TRUE, "na", white_color),
    education21 = ifelse(is.na(education2) == TRUE, "na", education2),
    asthma1 = ifelse(is.na(asthma) == TRUE, "na", asthma)
  )
  
#PSM -  method = "nearest", ratio = 1
psm1 <- matchit(vaccine1 ~ white_color1 + age + education21 + asthma1, data = data_final1, method = "nearest", ratio =1)

summary(psm1)
plot(psm1, type = "jitter", interactive = FALSE)
plot(psm1, type = "qq", interactive = FALSE,
     which.xs = c("white_color1","age","education21","asthma1"))
plot(summary(psm1))

#PSM -  method = "optimal", distance = "logit",
psm2 <- matchit(vaccine1 ~ white_color1 + age + education21 + asthma1, data_final1, method = "optimal", distance = "logit", estimand =  "ATT")

summary(psm2)
plot(psm2, type = "jitter", interactive = FALSE)
plot(psm2, type = "qq", interactive = FALSE,
     which.xs = c("white_color1","age","education21","asthma1"))
plot(summary(psm2))
```

The best is PSM with the nearest method.

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
#Selecting only the selected observations
data_aux <- data_final1[psm1$weights==1, ]

#Now let's join data_aux with data_final

data_psm <- right_join(data_final, data_aux, by= c("id", "vaccine1", "white_color", "age", "education2", "asthma"))

freq(data_psm$vaccine)
```

## For symptoms


### Fever

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, fever, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

### Cough

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, cough, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```


### Sore throat

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, sore_throat, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

###  Dyspnea

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, dyspnea, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

###  Respiratory discomfort

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, resp_disc, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

### Desaturation

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, desaturation, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

### Diarrhea

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, diarrhea, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

###  Vomit

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, vomit, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

### Abdominal pain

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, abd_pain, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

### Fatigue

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, fatigue, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

### Olfactory loss

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, olfac_loss, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

### Loss of taste

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, loss_taste, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

### Any respiratory symptom

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, resp_symp, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

### Any symptom

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, symptom, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```


## For outcomes

### Hospitalization

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, hospitalization, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```


### ICU

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, icu, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

### Length time in ICU
```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
data_psm_aux <- data_psm %>% 
  filter (icu == "yes")
```

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
datasummary((vaccine) ~ time_icu*(n+media+DP+mediana+q25+q75+IQR),
            data = data_psm_aux, output = 'markdown')
```

```{r, echo=TRUE, eval= TRUE, message=FALSE, warning =FALSE, error=FALSE}
#t-test
t.test(time_icu ~ vaccine, data = data_psm_aux)
```

### Ventilatory support

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, ventilatory_support, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

### Intubation

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, intubation, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

### Death

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
with(data_psm, ctable(vaccine, death, prop = "r", useNA = "no", chisq = TRUE, OR=TRUE))
```

# Vaccination and mortality maps

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
data_final_vac <- data_final %>% 
 filter(vaccine == "no")

valor_vac <- data.frame(table(data_final_vac$SG_UF))
colnames(valor_vac) <- c("uf", "n_vac")

valor <- data.frame(table(data_final$SG_UF))
colnames(valor) <- c("uf", "n")

dt_estado <- left_join(valor, valor_vac, by= "uf")

dt_estado  <- dt_estado %>% 
  mutate(n_vac = ifelse(is.na(n_vac), 0, n_vac))

dt_estado  <- dt_estado %>% 
  mutate(T1 = (n_vac/n)*100)

dt_estado1 <- dt_estado
dt_estado1 <- dt_estado1 %>% 
  rename(T2=T1)
  
print(dt_estado)

dt <- rbind(c("AC",12), c("AL",27), c("AP",16), c("AM",13), c("BA",29), 
              c("CE",23), c("DF",53), c("ES",32), c("GO",52), c("MA",21), 
              c("MT",51), c("MS",50), c("MG",31), c("PA",15), c("PB",25), 
              c("PR",41), c("PE",26), c("PI",22), c("RN",24), c("RS",43), 
              c("RJ",33), c("RO",11), c("RR",14), c("SC",42), c("SP",35), 
              c("SE",28), c("TO",17)) %>% data.table %>% `colnames<-`(c("uf","id"))
              
mapaUF <- readRDS("mapaUF.Rds")

dt2 <- full_join(dt, dt_estado, by = "uf")
g1 <- ggplot(dt2) +
  geom_map(map = mapaUF, color = 'gray30', aes_string(map_id = "id", fill = "T1")) +
  geom_path(data = mapaUF, color = 'gray30', size = .1, aes(x = long, y = lat, group = group)) + 
  theme_void() + coord_equal() + 
  labs(fill = "Not-vaccinated rate", title = "")  + 
  scale_fill_distiller(palette="Purples", trans="reverse", limits = c(100,0)) 

g1
```


```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
data_final_death <- data_final %>% 
 filter(death == "death")

valor_death <- data.frame(table(data_final_death$SG_UF))
colnames(valor_death) <- c("uf", "n_death")

valor <- data.frame(table(data_final$SG_UF))
colnames(valor) <- c("uf", "n")

dt_estado <- left_join(valor, valor_death, by= "uf")

dt_estado  <- dt_estado %>% 
  mutate(n_death = ifelse(is.na(n_death), 0, n_death))

dt_estado  <- dt_estado %>% 
  mutate(T1 = (n_death/n)*100)
  
print(dt_estado)

dt <- rbind(c("AC",12), c("AL",27), c("AP",16), c("AM",13), c("BA",29), 
              c("CE",23), c("DF",53), c("ES",32), c("GO",52), c("MA",21), 
              c("MT",51), c("MS",50), c("MG",31), c("PA",15), c("PB",25), 
              c("PR",41), c("PE",26), c("PI",22), c("RN",24), c("RS",43), 
              c("RJ",33), c("RO",11), c("RR",14), c("SC",42), c("SP",35), 
              c("SE",28), c("TO",17)) %>% data.table %>% `colnames<-`(c("uf","id"))
              
mapaUF <- readRDS("mapaUF.Rds")

dt2 <- full_join(dt, dt_estado, by = "uf")
g2 <- ggplot(dt2) +
  geom_map(map = mapaUF, color = 'gray30', aes_string(map_id = "id", fill = "T1")) +
  geom_path(data = mapaUF, color = 'gray30', size = .1, aes(x = long, y = lat, group = group)) + 
  theme_void() + coord_equal() + 
  labs(fill = "Death rate", title = "")  + 
  scale_fill_distiller(palette="Purples", trans="reverse", limits = c(100,0)) 

g2

```
 
Spearman correlation between \% unvaccinated and \% death:

```{r, echo=TRUE,message=FALSE,warning =FALSE,error=FALSE}
dt_cor <- full_join(dt_estado, dt_estado1, by = "uf")

SpearmanRho(dt_cor$T1, dt_cor$T2, conf.level=0.95)
cor.test(dt_cor$T1, dt_cor$T2, method = "spearman")
```